#!/bin/bash

module load singularity 2> /dev/null

# create brainmask
#singularity exec -e docker://brainlife/vistasoftregistration ./brainmask.sh
singularity exec -e docker://brainlife/fsl:5.0.9 ./brainmask.sh

if [ ! -s nodif.nii.gz ];
then
	echo "output missing"
	exit 1
fi

# NODDI via AMICO
singularity exec -e docker://brainlife/amico:1.0 ./NODDI.py

if [ ! -s ./NODDI/AMICO/NODDI/FIT_ICVF.nii.gz ];
then
	echo "output missing"
	exit 1
fi

# registration
singularity exec -e docker://brainlife/mcr:neurodebian1604-r2017a ./compiled/main

# clean up
noddiImages="FIT_ICVF_NEW.nii.gz FIT_ISOVF_NEW.nii.gz FIT_OD_NEW.nii.gz FIT_dir.nii.gz config.pickle";

for NODDIIMAGES in $noddiImages
	do
		mv ./NODDI/AMICO/NODDI/${NODDIIMAGES} ./
	done

rm -rf ./NODDI;
rm -rf *nodif*;
rm -rf ./kernels;

echo "NODDI AMICO complete"

if [ ! -s FIT_ICVF_NEW.nii.gz ];
then
	echo "output missing"
	exit 1
fi
